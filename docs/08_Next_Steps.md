# 下一步測試與開發計劃

## 📋 當前狀態

**最新提交**：`99a5929` - 實作雙向表面檢測與修復控制系統  
**Phase 1 進度**：約 70% 完成  
**測試狀態**：基礎功能已驗證，高級功能待測試

---

## 🧪 Phase 1 剩餘測試項目

### 1. 高速粘附測試 🚀

**目標**：驗證速度 > 350 px/s 時的粘附功能

**測試步驟**：
1. 在 Godot 編輯器中打開 `res://src/levels/test/poc_physics.tscn`
2. 按右箭頭持續加速
3. 觀察速度達到 350+ px/s 時的行為

**預期結果**：
- ✅ `Adhered: YES` 顯示在調試文字中
- ✅ 青色表面法線向量出現
- ✅ 車輛保持貼地（不受重力影響）
- ✅ 自定義重力系統激活

**檢查點**：
- [ ] 速度能達到 350+ px/s
- [ ] `Adhered` 狀態正確切換
- [ ] 表面法線方向正確
- [ ] 車輛不會因重力掉落

**參數調整（如需要）**：
```gdscript
// 如果太難達到粘附速度
const ADHESION_VELOCITY_THRESHOLD: float = 250.0  // 降低閾值

// 如果粘附後容易掉落
const ADHESION_HYSTERESIS: float = 75.0  // 增加滯後
```

---

### 2. 斜坡跳躍與空中控制測試 🛫

**目標**：驗證空中旋轉控制功能

**測試步驟**：
1. 加速到 300+ px/s
2. 駛上斜坡（位置：x=400）
3. 車輛飛離地面後，按左/右箭頭

**預期結果**：
- ✅ 車輛離地時 `Mode: AIR`
- ✅ `Surface: NONE`
- ✅ 所有射線變紅色（未檢測到表面）
- ✅ 按左箭頭：逆時針旋轉
- ✅ 按右箭頭：順時針旋轉
- ✅ 旋轉速度約 1.3 秒/圈

**檢查點**：
- [ ] 空中狀態正確切換
- [ ] 空中旋轉響應靈敏
- [ ] 旋轉速度適中（可控）
- [ ] 著陸後恢復地面控制

**參數調整（如需要）**：
```gdscript
// 如果旋轉太慢
const AIR_TORQUE: float = 1200.0  // 增加空中扭矩

// 如果旋轉太快（失控）
const AIR_TORQUE: float = 500.0  // 降低空中扭矩
```

---

### 3. 天花板行駛測試（手動設置）🙃

**目標**：驗證倒掛行駛功能

**測試步驟**：
1. 在 Godot 編輯器中選中 Vehicle 節點
2. 在 Inspector 中將 `Transform > Rotation` 設為 `180°`
3. 將 Vehicle 放置到天花板下方（y = -400）
4. 運行場景，按右箭頭

**預期結果**：
- ✅ `Surface: CL CR`（Ceiling Left + Ceiling Right）
- ✅ 向上的射線變綠色
- ✅ 向下的射線變紅色
- ✅ 車輛可以在天花板上移動
- ✅ 表面法線指向下方

**檢查點**：
- [ ] 天花板檢測正常
- [ ] 車輛能在天花板加速
- [ ] 表面法線計算正確
- [ ] 不會因重力掉落

---

### 4. 表面過渡測試 🔄

**目標**：驗證從地面到天花板的過渡

**測試方案**：
1. 創建垂直牆面或彎曲賽道
2. 高速駛入過渡區域
3. 觀察表面法線變化

**預期結果**：
- ✅ 表面法線平滑過渡
- ✅ `Surface` 狀態正確顯示（如 `GL CR`）
- ✅ 車輛不會在過渡時掉落
- ✅ 多點法線平均計算正確

**注意**：此測試需要合適的賽道，可能需要先實作 Track Generation 工具

---

## 🛠️ Phase 1 剩餘開發任務

### 1. Track Generation Tool 📐

**優先級**：🔴 高（解鎖完整測試）

**需求**：
- 將 Path2D 轉換為 CollisionPolygon2D
- 支援平滑曲線採樣
- 可調整賽道寬度
- 自動生成碰撞形狀

**實作文件**：
- `src/tools/track_generator.gd`（EditorScript）
- 或 `src/components/track_builder/`（運行時工具）

**參考文檔**：
- `docs/02_Architecture.md`（提到了這個需求）

---

### 2. 參數微調文檔 📊

**目標**：記錄測試後的最佳參數配置

**需要調整的參數**：
- 摩擦力（當前 0.8）
- 扭矩值（當前 5000/800）
- 粘附閾值（當前 300）
- RayCast 長度（當前 64）

**建議格式**：
```markdown
## 參數調整記錄

### 2026-01-20 - 初始配置
- WHEEL_FRICTION: 0.8
- 理由：測試發現 0.1 太滑

### 2026-01-XX - 高速測試後
- ADHESION_VELOCITY_THRESHOLD: 250.0
- 理由：350 太難達到
```

---

### 3. 自動化測試場景 🤖

**目標**：創建可重複的測試場景

**建議場景**：
- `test_ground_acceleration.tscn`：地面加速測試
- `test_air_control.tscn`：空中控制測試
- `test_ceiling_adhesion.tscn`：天花板粘附測試
- `test_loop_de_loop.tscn`：完整循環賽道測試

**實作位置**：`src/levels/test/`

---

## 📈 Phase 2 準備工作

### 1. 多人輸入系統 👥

**當前狀態**：使用全局 `Input.get_axis()`

**需要改為**：
```gdscript
# Player 1
Input.get_axis("p1_left", "p1_right")

# Player 2
Input.get_axis("p2_left", "p2_right")
```

**實作方案**：
- 在 `vehicle_controller.gd` 添加 `player_id` 參數
- 在 `project.godot` 定義 P1/P2 輸入映射

---

### 2. Split-Screen 相機系統 📹

**需求**：
- 雙玩家分屏顯示
- 動態縮放（保持兩車在畫面內）
- 可能的旋轉（視角跟隨車頭）

**實作文件**：
- `src/entities/camera/split_screen_camera.gd`

**參考**：
- 當前已有 `camera_follower.gd`（單人）
- 需要擴展為多人支援

---

### 3. 視覺增強 🎨

**優先清單**：
1. 車輛精靈動畫（替換 ColorRect）
2. 車輪旋轉動畫
3. 粒子特效（尾跡、減速）
4. 賽道視覺樣式（替換灰色方塊）

**資源需求**：
- 像素藝術素材（32x32 or 64x64）
- 參考原版 Flipside 的風格

---

### 4. 音頻系統 🎵

**音效清單**：
- 引擎聲（隨速度變化音調）
- 碰撞音效
- 加速音效
- UI 音效（倒數計時、勝利）

**實作方案**：
- `src/_core/audio_manager.gd`（Autoload）
- AudioStreamPlayer 節點管理

---

## 📝 測試記錄模板

### 測試日期：____

#### 測試項目：高速粘附測試

**測試人員**：  
**Godot 版本**：4.5.1  
**提交版本**：99a5929

**測試結果**：
- [ ] 速度達到 350+ px/s
- [ ] Adhered 狀態切換正確
- [ ] 表面法線顯示正確
- [ ] 車輛保持粘附

**發現問題**：
1. 
2. 

**參數調整建議**：


**截圖/錄屏**：


---

## 🎯 本週目標

### Week 1（當前週）
- [x] 實作雙向表面檢測 ✅
- [x] 修復控制系統 ✅
- [x] 配置 LSP 環境 ✅
- [ ] 完成 Phase 1 所有測試
- [ ] 記錄測試結果

### Week 2
- [ ] 實作 Track Generation 工具
- [ ] 創建測試賽道場景
- [ ] 開始 Phase 2 多人系統

---

## 💡 已知限制與未來改進

### 當前限制
1. **單人輸入**：硬編碼使用 `ui_left/ui_right`
2. **無賽道編輯器**：需要手動在 Godot 編輯器中創建
3. **無視覺反饋**：僅有基礎幾何圖形
4. **無音頻**：完全靜音

### 改進計劃
1. **物理優化**：
   - 減少彈跳（調整 damping）
   - 更平滑的力施加
   - 碰撞響應調整

2. **控制優化**：
   - 手把支援（模擬搖桿）
   - 可調整靈敏度
   - 輸入緩衝（防止掉輸入）

3. **調試工具**：
   - 即時參數調整面板
   - 物理狀態記錄器
   - 慢動作模式

---

## 📚 相關資源

### 文檔
- `docs/02_Architecture.md` - 物理系統設計
- `docs/06_Control_System.md` - 控制系統詳解
- `docs/07_Session_2026-01-20.md` - 今日工作記錄

### 場景
- `src/levels/test/poc_physics.tscn` - 主測試場景
- `src/entities/vehicle/vehicle.tscn` - 車輛預製體

### 腳本
- `src/_core/global_constants.gd` - 全局參數
- `src/entities/vehicle/vehicle_controller.gd` - 車輛邏輯

---

## ✅ 完成檢查清單

在進入 Phase 2 之前，確認：

- [ ] 所有 Phase 1 測試通過
- [ ] 參數調整並記錄
- [ ] Track Generation 工具完成
- [ ] 至少一個完整測試賽道
- [ ] 文檔更新完整
- [ ] 代碼已提交並推送

---

**最後更新**：2026-01-20  
**下次會話建議**：執行高速粘附測試與斜坡測試
